<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="_s8zp9HC5xK3I7RCh_8RJrSUgYtyNgc09bZvTV11nFI"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="imbant 前端工程师技术博客"><meta name="keywords" content="前端,imbant,技术博客,浏览器,Electron,React,Vue,Node,Webpack,Vite,Chrome"><title>LSP 与 VS Code 插件开发 第一章 | imbAnt's blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','G-ZM9NGRYKWS','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">LSP 与 VS Code 插件开发 第一章</h1><a id="logo" href="/blog/.">imbAnt's blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">LSP 与 VS Code 插件开发 第一章</h1><div class="post-meta">2024-08-24</div><div class="post-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我是一名语言服务器开发者、VS Code 插件开发者。<br>我开发了这款<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=craftLandstudio.ffugclanguage">插件</a>。它集成了一个基于 <code>LSP</code> 的语言服务器，可以为自研编程语言提供智能编程功能。</p>
<p>如果这些名词对你来说还很陌生，可以考虑这个问题：<br>当你在电脑上首次安装 VS Code，创建一个 <code>.vue</code> 文件，会发现在其中编写代码是非常困难的——体验几乎和面试时要求你白板写代码一样痛苦！</p>
<ul>
<li>黑纸白字，变量都是一个颜色</li>
<li>想要打印日志，需要在键盘上按 <code>c</code>-<code>o</code>-<code>n</code>-<code>s</code>-<code>o</code>-<code>l</code>-<code>e</code>-<code>.</code>-<code>l</code>-<code>o</code>-<code>g</code> 一共 11 次，才能输入需要的函数名</li>
<li>单词拼错了，console 拼成 consol<strong>a</strong>，webpack 编译报错，但编辑器没有错误提示</li>
</ul>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/lsp-vscode/plaintext.png"></p>
<p>这太痛苦了！单独写 HTML 或者 JS 都没问题，为什么 vue 文件就这么难写呢？</p>
<p>这时你搜索到一个插件：<code>Vue - Official</code>，安装后，这些问题都解决了：变量、标签都有了各自的颜色，输入 <code>con</code> 就能补全出 <code>console</code>，写错的 <code>consola</code> 也被红色波浪线标识了。</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/lsp-vscode/installextension.png"></p>
<p>这些功能叫做</p>
<ul>
<li>语法高亮</li>
<li>语义高亮</li>
<li>自动补全</li>
<li>错误提示</li>
</ul>
<p>当你深入使用 VS Code 编码后，会发现更多智能编程功能，比如</p>
<ul>
<li>跳转到定义</li>
<li>悬浮提示</li>
<li>查找引用/查找实现</li>
<li>函数签名提示</li>
<li>重命名</li>
<li>…</li>
</ul>
<p>Vue 插件做了哪些事情，才让你的编程体验变得如此美好呢？为什么一定要安装插件才能有这些功能呢？为什么 <code>.ts</code>、<code>.html</code> 文件就不用安装插件？</p>
<p>这就引出了另一个问题：</p>
<p>假设你要发布一门全新的技术，引领新的技术潮流，用户需要在全新类型的文件中编码——就和 <code>.vue</code> 还有 <code>.astro</code> 做的事情一样，那你一定要解决这个问题：避免用户在全新文件中编码时，体验和白板写代码一样痛苦。</p>
<p>问题来了，你要怎么做？需要写一个 VS Code 插件吗？如何实现这些智能编程功能？那些喜欢用 Vim 写代码的人又怎么办？</p>
<h2 id="VS-Code-插件-——-能用-js-实现的，最终都会用-js-实现"><a href="#VS-Code-插件-——-能用-js-实现的，最终都会用-js-实现" class="headerlink" title="VS Code 插件 —— 能用 js 实现的，最终都会用 js 实现"></a>VS Code 插件 —— 能用 js 实现的，最终都会用 js 实现</h2><blockquote>
<p>Any application that can be written in JavaScript, will eventually be written in JavaScript - Jeff Atwood</p>
</blockquote>
<p>我们先从 VS Code 入手，看看它是如何设计，使得开发者能接入新语言的：它通过出色的插件系统，将内部代码封装成接口暴露出来，供插件调用。这些 API 就包括了高亮、自动补全、错误提示等等功能。这些功能都是数据驱动的，换句话说，这些智能编程功能，具体是由 VS Code 开发者一行一行代码实现的，将输入数据转化为 DOM 操作；而插件开发者无需关注细节，只需要提供符合格式的数据即可。</p>
<p>例如，你可以写一个简单的插件，让注释里的 <code>TODO</code> 高亮显示：逻辑非常简单，匹配文本中的 TODO 字符，记录它的行列号，给出高亮的颜色。事实上这个简单的插件已经<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=wayou.vscode-todo-highlight">有人写了</a>，并且有 400w+ 的下载量。</p>
<p>从技术栈来说，VS Code 是一个 Electron 应用，由 <code>HTML</code>、<code>CSS</code> 和 <code>JS</code> 构建。这意味着那些强大的智能编程功能，都可以由前端技术栈实现，只需要学习一些 VS Code API，你就能开发出自己语言的插件。</p>
<h4 id="HTML、CSS、JS-的内置支持"><a href="#HTML、CSS、JS-的内置支持" class="headerlink" title="HTML、CSS、JS 的内置支持"></a>HTML、CSS、JS 的内置支持</h4><p>回答刚才的问题，为什么 VS Code 认识 HTML 文件？同样是前端技术构建的应用，VS Code 已经对常见的代码文件有了内置的支持——内置了 <a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode/tree/main/extensions/typescript-language-features"><code>ts</code></a>、<a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode/tree/main/extensions/css-language-features"><code>css</code></a>、<a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode/tree/main/extensions/html-language-features"><code>html</code></a> 的插件，天然支持这些语言的智能编程功能。你可以在 VS Code 内按 <code>F1</code>，输入<code>Show Built-in Extensions</code>，查看全部内置插件。</p>
<h4 id="插件架构"><a href="#插件架构" class="headerlink" title="插件架构"></a>插件架构</h4><p><img src="https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-illustration.png"></p>
<p>先看这张图的左边：Electron 应用有主进程和渲染进程之分；我们看到的编辑器窗口，就是一个渲染进程。渲染进程又新开了一个插件专用的子进程，叫做 <code>Extension Host</code>，你用 Node.js 编写的插件就在这个子进程中运行。</p>
<p>打开你的 VS Code，看看你现在有多少个插件？我有 73 个。</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/lsp-vscode/extensionCount.png"></p>
<p>事实上，这 73 个插件都运行在<strong>同一个</strong>进程，也就是 <code>Extension Host</code> 里。这意味着</p>
<ol>
<li>插件行为与渲染进程独立，插件通过 IPC 影响页面表现，插件 crash 不会影响到用户正常编码（只是智能编程功能可能就挂了，例如写 TS 时偶尔会遇到悬浮提示、自动补全都一直 loading）。</li>
<li>各个插件之间共享上下文。碰到过很有意思的情况是，我在自己的插件中部署了 Sentry，而它捕获到了 json 插件的报错。</li>
<li>运行缓慢的插件，虽然不会拖慢渲染进行的速度，但由于提高了整体插件进程的开销，会拖累其他插件的速度。</li>
<li>同样由于共享资源，单个插件处理 CPU 密集型任务时性能不好。</li>
</ol>
<p>分享几个插件管理小技巧：</p>
<ul>
<li>查看启动性能：VS Code 指令 <code>Show Running Extensions</code> 可以列出插件的启动时间，也有 Profile 能力，用来查看运行缓慢的插件。</li>
<li>二分法检查问题：当 VS Code 用起来总是有问题，还有个<a target="_blank" rel="noopener" href="https://code.visualstudio.com/blogs/2021/02/16/extension-bisect">二分查找法</a>功能，用来关闭一半的插件，看看问题是否解决。持续二分，直到找到问题插件。</li>
</ul>
<h4 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h4><p>这里就不堆砌官方的文档教程了。我只是想告诉你 Why and How。如果想尝试写一个使用 VS Code API 的插件，可以从<a target="_blank" rel="noopener" href="https://code.visualstudio.com/api/get-started/your-first-extension">这个教程</a>看起。相信等你看完全部教程，已经能成为插件高手，可以尝试动手解决一些日常开发中碰到的痛点了。</p>
<h2 id="语言服务器-——-服务任何代码编辑器"><a href="#语言服务器-——-服务任何代码编辑器" class="headerlink" title="语言服务器 —— 服务任何代码编辑器"></a>语言服务器 —— 服务任何代码编辑器</h2><p>前边提到了 VS Code 插件的一个痛点：处理 CPU 密集型任务时性能不好。<br>还有另一个问题，我们一直在讨论 VS Code 内的开发，又如何应对其他代码编辑器的用户？那些使用 Vim、Atom 的用户，难道要强制他们安装 VS Code 吗？这似乎也不是个优雅的方案。<br>此外还有更致命的问题，插件只能使用 JS 编写，可如果新技术并非使用相关的技术栈呢？<br>如何让 VS Code 支持 <code>Python</code>、<code>Java</code>、<code>Go</code> 等语言？Google 推广 <code>Go</code> 时，又该如何让多个编辑器支持这门语言？</p>
<p>微软想出一个方案来解决这三个问题：<a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/">Language Server Protocol（语言服务器协议）</a>。</p>
<p><img src="https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-languages-editors.png" alt="lsp"></p>
<p>首先，创建一个独立进程：在独立进程中计算，来获取更多的 CPU 和内存资源，以提供语言服务。这个进程，我们叫做 <code>Language Server（语言服务器）</code>。由于是脱离了 VS Code 的独立进程，到底由什么编程语言编写就没有限制了。</p>
<p>那么编辑器（语言客户端）和语言服务器之间，就需要进程间的通信。如果你已经读过 VS Code 的官方教程就会发现，“用数据描述智能编程功能”是一件相当复杂的事情，双方需要相互告知大量且丰富的数据。</p>
<p>例如跳转到定义，客户端会告知当前光标的行列号、当前的文本内容；服务器需要返回定义的行列号。</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/lsp-vscode/gotodefinition.png" alt="go to definition"></p>
<p>这就需要一个协议，规定客户端和服务器之间通信的数据格式，这就是 <code>LSP</code> 了。它和 <code>HTTP</code> 协议有点类似，但更轻量，仅用于智能编程功能的通信。</p>
<h4 id="挟-LSP-以令编辑器"><a href="#挟-LSP-以令编辑器" class="headerlink" title="挟 LSP 以令编辑器"></a>挟 LSP 以令编辑器</h4><p>接下来就需要客户端，也就是代码编辑器们需要适配此协议了。LSP 是微软推出的标准，旗下的 VS Code 自然是首先支持的编辑器。Vim、Atom 等编辑器也有了很好的支持。</p>
<p>但推行这个标准不是一帆风顺的。BetBrains 家的付费编辑器，例如 WebStrom，对 LSP 的支持就<a target="_blank" rel="noopener" href="https://plugins.jetbrains.com/docs/intellij/language-server-protocol.html">不太积极</a>，从 2023 年，才开始支持部分 LSP 功能。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-illustration.png"></p>
<p>现在，我们的 VS Code 语言插件的架构比较明了，重新看这张图：</p>
<ul>
<li>左边是 VS Code，它的渲染进程起了子进程 <code>Extension Host</code>，运行多个插件</li>
<li>插件作为语言客户端，其业务逻辑非常薄，功能就是启动语言服务器，并基于 LSP 与语言服务器通信</li>
<li>语言服务器是一个独立进程，实现了最核心的业务逻辑，可以用任何编程语言编写，利用独立进程的算力，计算出客户端所需的数据，返回给客户端</li>
</ul>
<p>说了这么多，其实还有一个核心问题没有解决：语言服务器做了什么事情？考虑刚才的跳转到定义的协议，客户端仅仅输入了当前光标的行列号和文本内容——甚至没有说明选中的是哪个函数、变量或是空白处，服务器就返回了其定义的行列号。</p>
<p>这种分析文本，返回结构化数据的过程，就是编译。语言服务器需要内置编译器吗？编译又是怎样的过程？我们下一章继续。</p>
<h2 id="更多资料"><a href="#更多资料" class="headerlink" title="更多资料"></a>更多资料</h2><p>我在播客 <a target="_blank" rel="noopener" href="https://www.xiaoyuzhoufm.com/episode/66a1197533ddcbb53cd7a063"><code>Web Worker</code></a> 上和几位 Vue 生态的大佬、团队成员们聊过 Vue 插件，欢迎收听。</p>
<p>我也会在<a target="_blank" rel="noopener" href="https://okjk.co/OUqto1">即刻</a>分享语言服务器相关的开发心得，计划将它们整理成系列文章，欢迎关注。 </p>
</div><div class="tags"><a href="/blog/tags/LSP/"><i class="fa fa-tag"></i>LSP</a><a href="/blog/tags/VS-Code/"><i class="fa fa-tag"></i>VS Code</a><a href="/blog/tags/%E8%AF%AD%E8%A8%80%E6%9C%8D%E5%8A%A1%E5%99%A8/"><i class="fa fa-tag"></i>语言服务器</a></div><div class="post-nav"><a class="pre" href="/blog/2024/10/29/VS-Code-Thankyou/">我为 VS Code 贡献了代码</a><a class="next" href="/blog/2023/08/21/RubyConf-China-2023-%E7%AC%94%E8%AE%B0/">RubyConf China 2023 笔记</a></div><div class="giscus"></div><script src="https://giscus.app/client.js" data-repo="imbant/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkyNDkzOTc0NDM=" data-category="General" data-category-id="DIC_kwDODt2Aw84Ch79K" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://imbant.github.io/blog"/></form></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><span id="footer-copyright">Copyright © </span><a href="/blog/." rel="nofollow">imbAnt's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script>const tag = document.getElementById('footer-copyright');const year = new Date().getFullYear();tag.innerText += year + ' ';</script></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/gifFavIcon.js"></script></div></body></html>