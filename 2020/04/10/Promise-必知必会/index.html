<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="_s8zp9HC5xK3I7RCh_8RJrSUgYtyNgc09bZvTV11nFI"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="imbant å‰ç«¯å·¥ç¨‹å¸ˆæŠ€æœ¯åšå®¢"><meta name="keywords" content="å‰ç«¯,imbant,æŠ€æœ¯åšå®¢,æµè§ˆå™¨,Electron,React,Vue,Node,Webpack,Vite,Chrome"><title>Promise å¿…çŸ¥å¿…ä¼š | imbAnt's blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZM9NGRYKWS"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-ZM9NGRYKWS');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Promise å¿…çŸ¥å¿…ä¼š</h1><a id="logo" href="/blog/.">imbAnt's blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/blog/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/blog/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container">Hi ğŸ‘‹ï¼Œæ¬¢è¿è®¿é—®æˆ‘çš„åšå®¢
æˆ‘æ˜¯ä¸€åå‰ç«¯å¼€å‘è€…ï¼ŒVS Code æ’ä»¶å’Œè¯­è¨€æœåŠ¡å™¨å¼€å‘è€…
æˆ‘ç›®å‰æ­£åœ¨æ„å»ºåŸºäº LSP çš„ <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=craftLandstudio.ffugclanguage">è¯­è¨€æœåŠ¡å™¨</a>ï¼Œä¹Ÿåœ¨ç»´æŠ¤ç”¨ Go æ„å»ºçš„ç¼–è¯‘å™¨ã€‚
åœ¨<a href="/about/">è¿™é‡Œ</a>æŸ¥çœ‹æ›´å¤šå…³äºæˆ‘çš„ä¿¡æ¯<br>æˆ‘å¸Œæœ›é€šè¿‡è¿™ä¸ªåšå®¢è®°å½•æŠ€æœ¯çŸ¥è¯†ï¼Œæå‡å½±å“åŠ›ã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹è¿™äº›æ–‡ç« ï¼š<br><a href="/2024/10/29/VS-Code-Thankyou/">æˆ‘ä¸º VS Code è´¡çŒ®äº†ä»£ç </a><br><a href="2024/08/24/LSP1/">LSP ä¸ VS Code æ’ä»¶å¼€å‘ ç¬¬ä¸€ç« </a><br><a href="2023/03/30/æ€ä¹ˆè®©-favicon-åŠ¨èµ·æ¥/">æ€ä¹ˆè®© favicon åŠ¨èµ·æ¥</a><div class="post"><h1 class="post-title">Promise å¿…çŸ¥å¿…ä¼š</h1><div class="post-meta">2020-04-10</div><div class="post-content"><p>æœ¬æ–‡å…ˆè®²è®²ç°æˆçš„ Promise å¯¹è±¡æ€ä¹ˆç”¨ï¼Œå†è®²æ€ä¹ˆæ„é€ ä¸€ä¸ª Promise å¯¹è±¡ã€‚</p>
<h2 id="æ€ä¹ˆç”¨"><a href="#æ€ä¹ˆç”¨" class="headerlink" title="æ€ä¹ˆç”¨"></a>æ€ä¹ˆç”¨</h2><p>é€šè¿‡<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF">äº‹ä»¶å¾ªç¯</a>æ¥å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°éƒ½æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•ä¼˜é›…çš„è°ƒç”¨å‡½æ•°ï¼Œç±»ä¼¼åŒæ­¥å‡½æ•°é‚£æ ·ï¼Ÿ</p>
<p>å‡è®¾æœ‰ä¸€ä¸ª<code>createAudioFileAsync()</code>å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€äº›<code>config</code>ï¼Œç„¶åå¼‚æ­¥çš„ç”ŸæˆéŸ³é¢‘æ–‡ä»¶ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">createAudioFileAsync();</span><br><span class="line">doSometingSync();</span><br><span class="line"><span class="comment">// ä½œç”¨åŸŸé‡Œè¿™ä¸ªåŒæ­¥å‡½æ•°æ‰§è¡Œå®Œåï¼ŒcreateAudioFileAsync æ‰ä¼šè¢«æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—é‡Œ</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥æ‰§è¡Œé¡ºåºæ˜¯å…ˆåè€…å†å‰è€…</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ç»™å¼‚æ­¥å‡½æ•°ä¼ ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œç­‰ç”ŸæˆéŸ³é¢‘æˆåŠŸæˆ–å¤±è´¥æ—¶è°ƒç”¨ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">createAudioFileAsync(</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* failure */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>ä½†è¿™æ ·å°±æœ‰ä¸ªé—®é¢˜ï¼šæƒ³åœ¨<code>createAudioFileAsync()</code>æˆåŠŸåæ‰§è¡Œçš„ä»£ç ï¼Œéƒ½è¦æ”¾åˆ°ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°é‡Œã€‚å›è°ƒå‡½æ•°æœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼ˆåªæ˜¯ç¼©è¿›ä¼šå¤šä¸€å±‚ï¼Œä½œç”¨åŸŸå¤šä¸€å±‚ï¼‰ï¼Œä½†å¦‚æœåç»­ä»£ç é‡Œè¿˜æœ‰å¼‚æ­¥å‡½æ•°å‘¢ï¼Ÿå†æ¬¡ç”¨è¿™ç§ä¼ å…¥å›è°ƒå‡½æ•°çš„æ–¹æ³•ï¼Œä»£ç ä¼šæ¨ªå‘æ‰©å±•ï¼Œé™·å…¥éš¾ä»¥è°ƒè¯•çš„å›è°ƒåœ°ç‹±ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">async1(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  async2(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    async3(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      async4(...);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è®©<code>createAudioFileAsync()</code>è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¿™æ ·åç»­çš„å›è°ƒå°±å¯ä»¥<em>ç»‘å®š</em>åœ¨è¯¥ Promise ä¸Šã€‚</p>
<p>ç”¨ Promise é‡å†™è¿™ä¸ªå‡½æ•°åï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼è°ƒç”¨å®ƒï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">createAudioFileAsync().then(</span><br><span class="line">  <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* failure */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…æ›´å¸¸è§çš„</span></span><br><span class="line">createAudioFileAsync()</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* failure */</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>è¿™ç§å†™æ³•ä¸‹åç»­è¿˜éœ€è¦è°ƒç”¨å¼‚æ­¥å‡½æ•°æ€ä¹ˆåŠï¼Ÿç”¨ promise é‡å†™æ¯ä¸ªå¼‚æ­¥å‡½æ•°ï¼ˆä¾‹å¦‚<code>syncFunc = () =&gt; new Promise(/* å¼‚æ­¥æ“ä½œ */)</code>ï¼‰ï¼Œç„¶åé“¾å¼è°ƒç”¨å°±å¥½äº†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">createAudioFileAsync()</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> syncFunc(value))</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> doSomething(value))</span><br><span class="line">  ...</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>é“¾å¼è°ƒç”¨å¯ä»¥è®©ä»£ç æ›´æ¸…çˆ½ï¼Œæ›´å¯è¯»å’Œå¯è°ƒè¯•ã€‚</p>
<h3 id="çº¦å®š"><a href="#çº¦å®š" class="headerlink" title="çº¦å®š"></a>çº¦å®š</h3><ol>
<li>å›è°ƒå‡½æ•°éœ€è¦ç­‰æœ¬è½®äº‹ä»¶å¾ªç¯å®Œæˆåæ‰ä¼šè°ƒç”¨ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰ã€‚</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  res(<span class="number">2</span>);</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å› ä¸º 1ï¼Œå³ä½¿ Promise å·²ç»è½¬åˆ°<code>fulfilled</code>æˆ–è€…<code>rejected</code>çŠ¶æ€ï¼Œåœ¨è¿™ä¹‹åæ·»åŠ çš„<code>then</code>ä¹Ÿä¼šè¢«å¼‚æ­¥è°ƒç”¨ã€‚</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> pro = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res(<span class="number">2</span>));</span><br><span class="line">pro.then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// then å†…çš„å‡½æ•°ä¼šè¢«å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œå› æ­¤ä¸€å®šæ˜¯æœ€åæ‰§è¡Œçš„</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¤šæ¬¡è°ƒç”¨<code>then()</code>å¯ä»¥ç»‘å®šå¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒä»¬ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚</li>
</ol>
<h2 id="æ˜¯ä»€ä¹ˆ"><a href="#æ˜¯ä»€ä¹ˆ" class="headerlink" title="æ˜¯ä»€ä¹ˆ"></a>æ˜¯ä»€ä¹ˆ</h2><p>ä»ä»£ç çš„è§’åº¦ï¼Œæ˜¯ä¸€ä¸ª JavaScript å¯¹è±¡ã€‚<br>ä»æ•°å­¦æ¨¡å‹çš„è§’åº¦ï¼Œæ˜¯ä¸€ä¸ªæœ‰é™çŠ¶æ€æœºã€‚</p>
<h3 id="promise-æ˜¯å¯¹è±¡"><a href="#promise-æ˜¯å¯¹è±¡" class="headerlink" title="promise æ˜¯å¯¹è±¡"></a>promise æ˜¯å¯¹è±¡</h3><p>å…¶æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°å½“å‚æ•°ï¼Œè°ƒç”¨æ„é€ å‡½æ•°ä¼š<strong>ç«‹å³æ‰§è¡Œ</strong>è¿™ä¸ªå‡½æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">  res(<span class="number">3</span>);</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">val</span>) =&gt;</span> <span class="built_in">console</span>.log(val));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å«åš<code>executor</code>ï¼Œæ¥å— <code>res</code>ã€<code>rej</code> ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ã€‚<br>å¦‚æœ<code>executor</code>å†… <code>res</code> è¢«è°ƒåŠ¨äº†ï¼Œpromise è½¬ä¸º <em>fulfilled</em> çŠ¶æ€ï¼›<br>å¦‚æœ <code>rej</code> è¢«è°ƒç”¨äº†ï¼Œå°±è½¬ä¸º <em>rejected</em> çŠ¶æ€<br>é€šå¸¸æ˜¯åœ¨<code>executor</code>ä¸­æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ ¹æ®æ‰§è¡Œç»“æœæ¥å†³å®šè°ƒç”¨ <code>res</code> æˆ–è€… <code>rej</code><br>å¦‚æœ<code>executor</code>æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºé”™è¯¯äº†ï¼Œpromise ç›´æ¥è½¬ä¸º <em>rejected</em> çŠ¶æ€</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fetch(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">      .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">      .then(<span class="function">(<span class="params">value</span>) =&gt;</span> res(value)); <span class="comment">// fetch ä¹Ÿè¿”å›ä¸€ä¸ª promise å¯¹è±¡å“¦</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    rej(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>promise è¿˜æœ‰ä¸€ç§ <em>pending</em> çŠ¶æ€ï¼Œä½œä¸ºå…¶åˆå§‹çŠ¶æ€ã€‚</p>
<h3 id="promise-å¯¹è±¡æ˜¯ä¸€ä¸ªçŠ¶æ€æœº"><a href="#promise-å¯¹è±¡æ˜¯ä¸€ä¸ªçŠ¶æ€æœº" class="headerlink" title="promise å¯¹è±¡æ˜¯ä¸€ä¸ªçŠ¶æ€æœº"></a>promise å¯¹è±¡æ˜¯ä¸€ä¸ªçŠ¶æ€æœº</h3><p>ä» <em>pending</em> çŠ¶æ€å•é¡¹è½¬æ¢ä¸º <em>fulfilled</em> æˆ–è€… <em>rejected</em> çŠ¶æ€ã€‚<br><strong>åªè¦</strong>å‘ç”Ÿäº†çŠ¶æ€è½¬å˜ï¼Œ<strong>å°±</strong>ä¼šè°ƒç”¨ Promise.prototype.<code>then</code> æ–¹æ³•ã€‚<br>ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šè°ƒç”¨ Promise.prototype.<code>catch</code>æ–¹æ³•å‘¢ï¼Ÿå…¶å®<code>catch</code>æ˜¯<code>then</code>çš„ä¸€ç§ç®€å†™ã€‚</p>
<blockquote>
<p><code>then(a, b)</code> å’Œ <code>then(a).catch(b)</code> è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼ŒåŒºåˆ«åœ¨äº <code>a</code> æŠ›å‡ºçš„é”™è¯¯ï¼Œåªæœ‰åè€…æ‰èƒ½ <code>catch</code> ä½</p>
</blockquote>
<h2 id="ä¼ å€¼"><a href="#ä¼ å€¼" class="headerlink" title="ä¼ å€¼"></a>ä¼ å€¼</h2><p>é€šå¸¸ï¼Œä¸¤ä¸ªå¼‚æ­¥å‡½æ•°è¦æŒ‰é¡ºåºæ‰§è¡Œï¼Œè‚¯å®šæ˜¯åä¸€ä¸ªè¦ç”¨åˆ°å‰ä¸€ä¸ªå¤„ç†è¿‡çš„å€¼ã€‚</p>
<p>å†é‡å¤ä¸€ä¸‹æ¦‚å¿µï¼Œã€Œpromise æ„é€ å‡½æ•°ã€æŒ‡<code>new Promise()</code>æ‹¬å·ä¸­ä¼ å…¥çš„å‡½æ•°ã€‚ã€Œthen å›è°ƒã€æŒ‡<code>.then()</code>æ‹¬å·ä¸­ä¼ å…¥çš„å‡½æ•°ã€‚</p>
<h3 id="ä»-promise-æ„é€ å‡½æ•°åˆ°-then-å›è°ƒ"><a href="#ä»-promise-æ„é€ å‡½æ•°åˆ°-then-å›è°ƒ" class="headerlink" title="ä» promise æ„é€ å‡½æ•°åˆ° then å›è°ƒ"></a>ä» promise æ„é€ å‡½æ•°åˆ° then å›è°ƒ</h3><p>é€šè¿‡åœ¨ promise æ„é€ å‡½æ•°ä¸­ç»™<code>res</code>æˆ–è€…<code>rej</code>ä¼ å‚ï¼Œå°±å¯ä»¥ç»™ then å›è°ƒå‡½æ•°ä¼ å€¼äº†ã€‚<code>res(1) ---&gt; then((x) =&gt; x), x = 1</code><br><code>then</code>æ¥å—ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼ŒçŠ¶æ€è½¬ä¸º<code>fulfilled</code>å°±è°ƒç”¨ç¬¬ä¸€ä¸ªï¼Œè½¬ä¸º<code>rejected</code>å°±è°ƒç”¨ç¬¬äºŒä¸ªã€‚å¸¸è§çš„<code>then</code>åªå†™ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>catch</code>å¸¸å¸¸å†™åœ¨ä¸€ä¸ª promise è°ƒç”¨é“¾çš„æœ€åï¼Œä½œä¸ºå…œåº•çš„é”™è¯¯å¤„ç†ã€‚<br><code>catch(func)</code>å…¶å®å°±æ˜¯ <code>then(null, func)</code>â€”â€”å®é™…ä¸Šï¼Œ<code>catch</code>å†…éƒ¨å°±æ˜¯è¿™ä¹ˆè°ƒç”¨<code>then</code>çš„ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ç«‹å³æ‰§è¡Œï¼Œ1ç§’ä¹‹åè°ƒç”¨ res()</span></span><br><span class="line">    res(<span class="number">1</span>); <span class="comment">// ç»™ then ä¼ å€¼ 1</span></span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value));</span><br><span class="line"><span class="comment">// 1ç§’åæ‰“å° 1</span></span><br></pre></td></tr></table></figure>

<h3 id="ä»-then-å›è°ƒåˆ°-then-å›è°ƒï¼ˆé“¾å¼è°ƒç”¨ï¼‰"><a href="#ä»-then-å›è°ƒåˆ°-then-å›è°ƒï¼ˆé“¾å¼è°ƒç”¨ï¼‰" class="headerlink" title="ä» then å›è°ƒåˆ° then å›è°ƒï¼ˆé“¾å¼è°ƒç”¨ï¼‰"></a>ä» then å›è°ƒåˆ° then å›è°ƒï¼ˆé“¾å¼è°ƒç”¨ï¼‰</h3><p>åŒæ ·çš„ï¼Œéœ€è¦åœ¨ then å›è°ƒä¸­è®¾å®šè¿”å›å€¼ï¼Œä¼ ç»™ä¸‹ä¸ª thenã€‚</p>
<p>é¦–å…ˆåŒºåˆ«ä¸€ä¸‹ã€Œthen çš„è¿”å›å€¼ã€ã€ã€Œthen å›è°ƒçš„è¿”å›å€¼ã€ï¼Œå‰è€…æŒ‡çš„æ˜¯<code>.then()</code>ï¼Œåè€…æŒ‡çš„æ˜¯æ‹¬å·å†…ä¼ å…¥çš„å‡½æ•°çš„è¿”å›å€¼ã€‚</p>
<p>then çš„è¿”å›å€¼ä¸ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œè¿™ä½¿å¾—<code>.then().then().then()</code>çš„è¯­æ³•æˆä¸ºå¯èƒ½ã€‚</p>
<p>å¦‚æœ then çš„å›è°ƒå‡½æ•°ï¼š</p>
<ul>
<li>æƒ³åœ¨ then å›è°ƒä¸­æ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œéœ€è¦è¿”å›ä¸€ä¸ª promise:<ul>
<li><em>pending</em> çŠ¶æ€ï¼Œthen è¿”å›çš„ promise çŠ¶æ€ä¹Ÿæœªå®šï¼Œä¸¤è€…çŠ¶æ€ä¼šåŒæ­¥ï¼ˆæ³¨æ„ï¼Œåªæ˜¯çŠ¶æ€åŒæ­¥ï¼Œä¸¤ä¸ª promise ä¾ç„¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚</li>
<li><em>fulfilled</em> çŠ¶æ€ï¼Œæ‰§è¡Œåä¸€ä¸ª then å›è°ƒã€‚</li>
<li><em>rejected</em> çŠ¶æ€ï¼Œæ‰§è¡Œåä¸€ä¸ª catch å›è°ƒã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res(<span class="number">1</span>))</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">&quot;...&quot;</span>); <span class="comment">// é‡å¤ä¸€éï¼Œfetch è¿”å›ä¸€ä¸ª promise å¯¹è±¡</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.json();</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res(<span class="number">1</span>))</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// æƒ³è¦åœ¨ then å›è°ƒä¸­æ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œéœ€è¦æŠŠå¼‚æ­¥å‡½æ•°åŒ…è£¹åœ¨ promise ä¸­å¹¶è¿”å›ã€‚</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        res(value + <span class="number">2</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">v</span>) =&gt;</span> <span class="built_in">console</span>.log(v)); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<ul>
<li>è¿”å›ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆ then çš„è¿”å›å€¼ä¼šä½œä¸º<code>fulfilled</code>çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆåä¸€ä¸ª thenï¼‰çš„å‚æ•°å€¼ã€‚<code>return value</code>ç­‰ä»·äº<code>return Promise.resolve(value)</code>ï¼Œè¿”å›äº†ä¸€ä¸ª fulfilled çš„ promise å¯¹è±¡ã€‚</li>
<li>æ²¡æœ‰è¿”å›å€¼ï¼Œundefined ä¼šä½œä¸ºä¸‹ä¸€ä¸ª then å‚æ•°å€¼ã€‚then è¿”å›çš„ promise ä¸º<em>fulfilled</em>çŠ¶æ€ã€‚</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res(<span class="number">1</span>))</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value; <span class="comment">// ç­‰ä»·äº return Promise.resolve(value)</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">v</span>) =&gt;</span> <span class="built_in">console</span>.log(v)) <span class="comment">// 1</span></span><br><span class="line">  .then(<span class="function">(<span class="params">v</span>) =&gt;</span> <span class="built_in">console</span>.log(v)); <span class="comment">// undefinedï¼Œconsole.log æ²¡æœ‰è¿”å›å€¼</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æŠ›å‡ºé”™è¯¯ï¼ŒæŠ›å‡ºçš„é”™è¯¯ä¼šä½œä¸ºæ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆåä¸€ä¸ª catchï¼‰çš„å‚æ•°å€¼ã€‚then è¿”å›çš„ promise ä¸º<em>rejected</em>çŠ¶æ€ã€‚</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res(<span class="number">1</span>))</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="number">1</span>;</span><br><span class="line">    a = <span class="number">2</span>; <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¿è¡Œæ—¶ä¼šè‡ªåŠ¨æŠ›å‡ºé”™è¯¯</span></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value)) <span class="comment">// ä¸ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.error(err)); <span class="comment">// TypeError: Assignment to constant variable.</span></span><br></pre></td></tr></table></figure>

<h3 id="then-çš„å‚æ•°ä¸ä¸ºå‡½æ•°"><a href="#then-çš„å‚æ•°ä¸ä¸ºå‡½æ•°" class="headerlink" title="then çš„å‚æ•°ä¸ä¸ºå‡½æ•°"></a>then çš„å‚æ•°ä¸ä¸ºå‡½æ•°</h3><p>then çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼šåœ¨ promise å˜ä¸º<code>fulfilled</code>æ—¶è°ƒç”¨ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå®ƒä¼šåœ¨å†…éƒ¨è¢«æ›¿æ¢ä¸º<code>x =&gt; x</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåŸæ ·è¿”å› promise æœ€ç»ˆç»“æœçš„å‡½æ•°ã€‚è¿™ç§è¡Œä¸ºç§°ä¸ºå‚æ•°ç©¿é€ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>.resolve(<span class="number">3</span>).then(<span class="number">4</span>).then(<span class="built_in">console</span>.log);</span><br><span class="line"><span class="comment">// 3ï¼Œä¸­é—´çš„ then(4) è¢«å†…éƒ¨æ›¿æ¢ä¸º then(x =&gt; x)</span></span><br><span class="line"><span class="comment">// 3 ä» promise ç©¿é€ç¬¬ä¸€ä¸ª thenï¼Œç›´æ¥ä¼ ç»™äº†ç¬¬äºŒä¸ª then</span></span><br></pre></td></tr></table></figure>

<h3 id="Promise-prototype-finally"><a href="#Promise-prototype-finally" class="headerlink" title="Promise.prototype.finally"></a>Promise.prototype.finally</h3><p>æƒ³è¦åœ¨ Promise æ‰§è¡Œå®Œæ¯•åæ— è®ºç»“æœæ€ä¹ˆæ ·éƒ½åšä¸€äº›å¤„ç†ï¼Œå¯ä»¥ç”¨<code>finally</code>ã€‚<br>è™½ç„¶ä¸<code>then</code>ç±»ä¼¼ï¼Œä½†ç”¨<code>finally</code>æ›´é€‚ç”¨äºé‚£äº›ç”¨<code>then</code>æ—¶ä¸¤ä¸ªå‚æ•°æœ‰ç›¸åŒä»£ç çš„æƒ…å†µï¼Œé¿å…å†™å†—ä½™çš„ä»£ç ã€‚<br><code>finally</code>åŒæ ·ä¸º Promise å¯¹è±¡ç»‘å®šä¸€ä¸ªäº‹ä»¶å›è°ƒï¼Œå¾… Promise çŠ¶æ€è½¬æ¢åè°ƒç”¨ï¼Œä¸è®ºç»“æœæ˜¯<code>fulfilled</code>æˆ–è€…<code>rejected</code>ï¼Œç„¶åè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚<br><code>finally</code>å†…å¿…å®šå‘ç”Ÿå‚æ•°ç©¿é€ï¼Œå›è°ƒæœ¬èº«çš„è¿”å›å€¼ä¸ä¼šä½œä¸º promise é“¾çš„ä¸€ç¯ï¼Œè€Œæ˜¯æŠŠä¸Šä¸ª promise çš„å€¼åŸæ ·ä¼ é€’ä¸‹æ¥ã€‚</p>
<p>ç”±äºä¸çŸ¥é“ Promise çŠ¶æ€ï¼Œæ‰€ä»¥<code>finally</code>çš„å›è°ƒæ˜¯æ²¡æœ‰å‚æ•°çš„ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line">  .finally(<span class="function">() =&gt;</span> <span class="number">2</span>)</span><br><span class="line">  .then(<span class="built_in">console</span>.log);</span><br><span class="line"><span class="comment">// 1ï¼Œä» resolve ç©¿é€ finally ä¼ é€’ç»™äº† then</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>finally</code>å›è°ƒä¹Ÿè¿”å›ä¸€ä¸ª Promiseï¼Œåˆ™ç­‰å…¶çŠ¶æ€è½¬æ¢åï¼Œ<code>finally</code>è¿”å›çš„ Promise æ‰ä¼šæ”¹å˜çŠ¶æ€ï¼Œä½†å›è°ƒè¿”å›çš„ Promise çŠ¶æ€ä¸å½±å“åç»­çš„è°ƒç”¨é“¾ã€‚åç»­çš„è°ƒç”¨é“¾ä¾ç„¶ç”±<code>finally</code>å‰çš„ Promise å†³å®šã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.reject(<span class="number">2</span>)</span><br><span class="line">  .finally(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> res(<span class="number">1</span>), <span class="number">1000</span>)))</span><br><span class="line">  .then(<span class="function">(<span class="params">v</span>) =&gt;</span> <span class="built_in">console</span>.log(v))</span><br><span class="line">  <span class="comment">// ä¸ä¼šè¢«è°ƒç”¨ï¼Œå’Œ finally å›è°ƒçš„ promise æ— å…³ï¼Œå’Œ finally å‰ä¸€ä¸ª promise æœ‰å…³</span></span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(err)); <span class="comment">// ä¸€ç§’åè¾“å‡º2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.reject(<span class="number">3</span>)</span><br><span class="line">  .finally(<span class="function">() =&gt;</span> <span class="number">2</span>)</span><br><span class="line">  .then(<span class="built_in">console</span>.log) <span class="comment">// ä¸ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">  .catch(<span class="built_in">console</span>.log); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>ä¸€å¥è¯ï¼Œç”¨äº†<code>finally</code>ä¸€å®šä¼šå€¼ç©¿é€ï¼Œå‰ä¸€ä¸ª Promise çš„çŠ¶æ€å’Œå€¼ï¼Œä¼šåŸå°ä¸åŠ¨çš„ä¼ ç»™<code>finally</code>è¿”å›çš„ Promiseã€‚</p>
<h3 id="é¢è¯•é¢˜åˆ†æ"><a href="#é¢è¯•é¢˜åˆ†æ" class="headerlink" title="é¢è¯•é¢˜åˆ†æ"></a>é¢è¯•é¢˜åˆ†æ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="built_in">setTimeout</span>(resolve)).then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="number">4</span>));</span><br><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">  .then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="number">2</span>))</span><br><span class="line">  .then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="number">3</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res())</span><br><span class="line">  .then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="number">5</span>))</span><br><span class="line">  .then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="number">6</span>));</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong>ï¼Œ<code>setTimeout</code>å‡½æ•°æœ¬èº«ä¼šæ¯”å…¶å‚æ•°å‡½æ•°ä¼˜å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¼˜å…ˆè¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼›åŒæ—¶<code>setTimeout</code>æœ¬èº«ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥ä¹Ÿå¾—ç­‰æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰å…¶ä»–æ¶ˆæ¯æ‰ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚</p>
<p>è§£æï¼š</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/8/Promise-%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A1.png" alt="img"></p>
<h2 id="å†™-Promise-çš„æœ€ä½³å®è·µ"><a href="#å†™-Promise-çš„æœ€ä½³å®è·µ" class="headerlink" title="å†™ Promise çš„æœ€ä½³å®è·µ"></a>å†™ Promise çš„æœ€ä½³å®è·µ</h2><ul>
<li>æ€»æ˜¯è¿”å›æˆ–è€…ç»ˆæ­¢ Promise é“¾</li>
<li>ä¸€æ—¦å¾—åˆ°ä¸€ä¸ªæ–°çš„ Promiseï¼Œè¿”å›å®ƒï¼Œè€Œä¸æ˜¯åµŒå¥—è°ƒç”¨ã€‚</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹ï¼ŒåŒ…å« 3 ä¸ªé—®é¢˜ï¼</span></span><br><span class="line">doSomething()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">    doSomethingElse(result) <span class="comment">// æ²¡æœ‰è¿”å› Promise ä»¥åŠæ²¡æœ‰å¿…è¦çš„åµŒå¥— Promise</span></span><br><span class="line">      .then(<span class="function">(<span class="params">newResult</span>) =&gt;</span> doThirdThing(newResult));</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">() =&gt;</span> doFourthThing());</span><br><span class="line"><span class="comment">// æœ€åï¼Œæ˜¯æ²¡æœ‰ä½¿ç”¨ catch ç»ˆæ­¢ Promise è°ƒç”¨é“¾ï¼Œå¯èƒ½å¯¼è‡´æ²¡æœ‰æ•è·çš„å¼‚å¸¸</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ€ä½³å®è·µ</span></span><br><span class="line">doSomething()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doSomethingElse(result);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">newResult</span> =&gt;</span> doThirdThing(newResult))</span><br><span class="line">  .then(<span class="function">() =&gt;</span> doFourthThing());</span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(error));</span><br></pre></td></tr></table></figure>

<h2 id="å…¶ä»–-API"><a href="#å…¶ä»–-API" class="headerlink" title="å…¶ä»– API"></a>å…¶ä»– API</h2><h3 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race"></a>Promise.race</h3><p>æ¥å—ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼ˆæ¯”å¦‚æ•°ç»„ï¼‰ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚<br>å¯è¿­ä»£å¯¹è±¡å†…ä»»ä½•ä¸€ä¸ª Promise è½¬ç§»çŠ¶æ€åï¼Œè¿”å›çš„ Promise å¯¹è±¡ä¹Ÿè½¬ç§»åˆ°åŒä¸€ä¸ªçŠ¶æ€ã€‚<br>å½“å¯è¿­ä»£å¯¹è±¡ä¸ºç©ºï¼ŒPromise å¯¹è±¡å§‹ç»ˆä¿æŒ<em>pending</em></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.race([</span><br><span class="line">  fetch(<span class="string">&quot;url&quot;</span>),</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      rej(<span class="string">&quot;è¶…æ—¶ï¼&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>)</span><br><span class="line">  ),</span><br><span class="line">])</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> value.json())</span><br><span class="line">  .then(<span class="built_in">console</span>.log(value))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(err));</span><br><span class="line"><span class="comment">// fetch åœ¨ 3ç§’å†…æ²¡èƒ½è¿”å›æ•°æ®çš„è¯ï¼Œä¼šç›´æ¥ log è¶…æ—¶</span></span><br><span class="line"><span class="comment">// æ­¤åå°±ç®— fetch è¿”å›äº†æ•°æ®ï¼Œä¹Ÿä¸ä¼šæ”¹å˜è¿”å›çš„ promise çŠ¶æ€</span></span><br></pre></td></tr></table></figure>

<h3 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all"></a>Promise.all</h3><p>æ¥å—ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚<br>å½“å¯è¿­ä»£å¯¹è±¡å†…å…¨éƒ¨ Promise éƒ½è½¬ä¸º<em>fulfilled</em>ï¼Œè¿”å›çš„ Promise è½¬ä¸º<em>fulfilled</em>ï¼›æ¯ä¸ª Promise çš„å€¼éƒ½ä¼šä¼ å…¥æ–° promise çš„å‚æ•°æ•°ç»„<br>å½“å¯è¿­ä»£å¯¹è±¡å†…æœ‰ä¸€ä¸ª Promise è½¬ä¸º<em>rejected</em>ï¼Œè¿”å›çš„ Promise ç«‹åˆ»è½¬ä¸º<em>rejected</em>ï¼Œä¸è®ºå¦å¤–çš„ä¼šæ€æ ·ã€‚<br>å½“å¯è¿­ä»£å¯¹è±¡ä¸ºç©ºï¼Œè¿”å› Promise å¯¹è±¡ä¼š<strong>åŒæ­¥</strong>çš„ç›´æ¥è½¬ä¸º<em>fulfilled</em>ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  <span class="built_in">Promise</span>.resolve(<span class="number">1</span>),</span><br><span class="line">  <span class="built_in">Promise</span>.resolve(<span class="number">2</span>),</span><br><span class="line">  <span class="built_in">Promise</span>.resolve(<span class="number">3</span>),</span><br><span class="line">]).then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value));</span><br><span class="line"><span class="comment">// [1,2,3]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([<span class="built_in">Promise</span>.resolve(<span class="number">1</span>), <span class="built_in">Promise</span>.resolve(<span class="number">2</span>), <span class="built_in">Promise</span>.reject(<span class="number">3</span>)])</span><br><span class="line">  .then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(err));</span><br><span class="line"><span class="comment">// 3ï¼Œä¸æ˜¯æ•°ç»„äº†</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise1 = <span class="built_in">Promise</span>.all([]);</span><br><span class="line"><span class="built_in">console</span>.log(promise1);</span><br><span class="line"><span class="comment">// Promise: &#123; &lt;state&gt;: &#x27;fulfilled&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise2 = <span class="built_in">Promise</span>.all([<span class="built_in">Promise</span>.resolve()]);</span><br><span class="line"><span class="built_in">console</span>.log(promise2);</span><br><span class="line"><span class="comment">// Promise: &#123; &lt;state&gt;: &#x27;pending&#x27; &#125;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(promise2));</span><br><span class="line"><span class="comment">// Promise: &#123; &lt;state&gt;: &#x27;fulfilled&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="async-await-è¯­æ³•ç³–"><a href="#async-await-è¯­æ³•ç³–" class="headerlink" title="async await è¯­æ³•ç³–"></a>async await è¯­æ³•ç³–</h2><p>ä¸å¾—ä¸è¯´ï¼Œä¸ºäº†è§£å†³å¼‚æ­¥æ“ä½œï¼ŒPromise ä¾ç„¶æœ‰é¢å¤–çš„å¤æ‚æ€§ã€‚</p>
<p>async å‡½æ•°è¯ç”Ÿäº ES2017ï¼Œæœ‰äººè®¤ä¸ºæ˜¯å¼‚æ­¥æ“ä½œçš„ç»ˆæè§£å†³æ–¹æ¡ˆã€‚çœ‹çœ‹ä» promise().then() çš„ä»£ç å¦‚ä½•ç”¨ async å‡½æ•°é‡å†™ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> demo1 = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result1 = <span class="keyword">await</span> fetch(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> result2 = <span class="keyword">await</span> fetch(result1);</span><br><span class="line">  <span class="built_in">console</span>.log(result2);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> demo2 = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  fetch(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">    .then(<span class="function">(<span class="params">result1</span>) =&gt;</span> fetch(result1))</span><br><span class="line">    .then(<span class="function">(<span class="params">result2</span>) =&gt;</span> <span class="built_in">console</span>.log(result2));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æŠ›å¼€ async å’Œ await å…³é”®å­—ï¼Œå†™èµ·æ¥ç®€ç›´å’ŒåŒæ­¥å‡½æ•°ä¸€æ ·ï¼<br>ä¸è¿‡åº•å±‚æœºåˆ¶ä¾ç„¶æ˜¯åˆ©ç”¨äº† Promiseï¼Œ<code>await</code>å…³é”®å­—åè¾¹éœ€è¦è·Ÿä¸€ä¸ª Promise å¯¹è±¡ï¼Œå…¶è¿”å›å€¼å°±æ˜¯ Promise æ„é€ å‡½æ•°é‡Œ resolve ä¼ å…¥çš„å€¼ã€‚<br>async å‡½æ•°æœ¬è´¨ä¸Šæ˜¯ Generator å‡½æ•°çš„è¯­æ³•ç³–ï¼Œå…¶ä¸­ Generator å‡½æ•°æ˜¯åç¨‹åœ¨ ES6 ä¸­çš„å®ç°ã€‚å®ƒå¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒï¼Œå³æš‚åœæ‰§è¡Œï¼Œæ¥å®ç°åƒæ˜¯åŒæ­¥å†™æ³•é‚£æ ·çš„å¼‚æ­¥æ“ä½œã€‚</p>
<p>Promise è§£å†³äº†å¤šä¸ªå¼‚æ­¥å‡½æ•°åŒæ­¥è°ƒç”¨é€ æˆçš„å›è°ƒåœ°ç‹±é—®é¢˜ï¼›async å‡½æ•°åˆ™è®©å¼‚æ­¥å‡½æ•°å†™èµ·æ¥æ›´åŠ ä¼˜é›…äº†ã€‚</p>
<h3 id="ç”¨-async-å‡½æ•°é‡å†™-promise-é“¾"><a href="#ç”¨-async-å‡½æ•°é‡å†™-promise-é“¾" class="headerlink" title="ç”¨ async å‡½æ•°é‡å†™ promise é“¾"></a>ç”¨ async å‡½æ•°é‡å†™ promise é“¾</h3><p>å‡å¦‚ promise é“¾çš„ä¸€éƒ¨åˆ†æ‰§è¡Œäº†å¦‚ä¸‹ä»£ç </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getProgressData = <span class="function">(<span class="params">url</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> downloadData(url) <span class="comment">// è¿”å›ä¸€ä¸ª Promise å¯¹è±¡</span></span><br><span class="line">    .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> downloadFallbackData(url); <span class="comment">// è¿”å›ä¸€ä¸ª Promise å¯¹è±¡</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> progresDataInWorker(result); <span class="comment">// è¿”å›ä¸€ä¸ª Promise å¯¹è±¡</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç”¨ async å‡½æ•°é‡å†™ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getProgressData = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> result;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = <span class="keyword">await</span> downloadData(url);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    result = <span class="keyword">await</span> downloadFallbackData(url);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ async å‡½æ•°çš„è¿”å›å€¼æ²¡æœ‰æ˜¾å¼çš„è¢« promise åŒ…è£¹ï¼Œå› ä¸º async å‡½æ•°ä¼šéšå¼åœ°å°†å®ƒä¼ é€’ç»™ Promise.resolveï¼Œè¿™æ ·éåŸç”Ÿ Promise ä¹Ÿèƒ½æ­£å¸¸ç”¨äº†ã€‚<br>å½“ await æŸä¸ª Promise æ—¶ï¼Œå‡½æ•°<em>æš‚åœ</em>æ‰§è¡Œï¼Œç›´è‡³è¯¥ Promise äº§ç”Ÿç»“æœï¼Œå¹¶ä¸”æš‚åœå¹¶ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œè¿™æ¶‰åŠåˆ°åç¨‹çš„æ¦‚å¿µã€‚<br>æœ‰å…³ async å‡½æ•°ã€åç¨‹ã€Generator å‡½æ•°ï¼Œæœ‰ç©ºå†èŠã€‚</p>
<h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><p><a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/primers/async-functions">å¼‚æ­¥å‡½æ•° - æé«˜ Promise çš„æ˜“ç”¨æ€§</a></p>
</div><div class="tags"><a href="/blog/tags/ES6/"><i class="fa fa-tag"></i>ES6</a></div><div class="post-nav"><a class="pre" href="/blog/2020/04/13/JS-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/">JS äº‹ä»¶å¾ªç¯</a><a class="next" href="/blog/2020/04/07/web-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91%E8%B8%A9%E5%9D%91/">web ç§»åŠ¨ç«¯å¼€å‘è¸©å‘</a></div><div class="giscus"></div><script src="https://giscus.app/client.js" data-repo="imbant/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkyNDkzOTc0NDM=" data-category="General" data-category-id="DIC_kwDODt2Aw84Ch79K" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://imbant.github.io/blog"/></form></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><span id="footer-copyright">Copyright Â© </span><a href="/blog/." rel="nofollow">imbAnt's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script>const tag = document.getElementById('footer-copyright');const year = new Date().getFullYear();tag.innerText += year + ' ';</script></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/gifFavIcon.js"></script></div></body></html>