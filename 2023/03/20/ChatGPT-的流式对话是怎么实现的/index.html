<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="_s8zp9HC5xK3I7RCh_8RJrSUgYtyNgc09bZvTV11nFI"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="imbant å‰ç«¯å·¥ç¨‹å¸ˆæŠ€æœ¯åšå®¢"><meta name="keywords" content="å‰ç«¯,imbant,æŠ€æœ¯åšå®¢,æµè§ˆå™¨,Electron,React,Vue,Node,Webpack,Vite,Chrome"><title>ChatGPT çš„æµå¼å¯¹è¯æ˜¯æ€ä¹ˆå®ç°çš„ | imbAnt's blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZM9NGRYKWS"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-ZM9NGRYKWS');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ChatGPT çš„æµå¼å¯¹è¯æ˜¯æ€ä¹ˆå®ç°çš„</h1><a id="logo" href="/blog/.">imbAnt's blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/blog/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/blog/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><p>Hi ğŸ‘‹ï¼Œæ¬¢è¿è®¿é—®æˆ‘çš„åšå®¢</p><p>æˆ‘æ˜¯ä¸€åå‰ç«¯å¼€å‘è€…ï¼ŒVS Code æ’ä»¶å’Œè¯­è¨€æœåŠ¡å™¨å¼€å‘è€…</p><p>æˆ‘ç›®å‰æ­£åœ¨æ„å»ºåŸºäº LSP çš„ <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=craftLandstudio.ffugclanguage">è¯­è¨€æœåŠ¡å™¨</a>ï¼Œä¹Ÿåœ¨ç»´æŠ¤ç”¨ Go æ„å»ºçš„ç¼–è¯‘å™¨ã€‚</p><p>åœ¨<a href="/about/">è¿™é‡Œ</a>æŸ¥çœ‹æ›´å¤šå…³äºæˆ‘çš„ä¿¡æ¯</p><br><p>æˆ‘å¸Œæœ›é€šè¿‡è¿™ä¸ªåšå®¢è®°å½•æŠ€æœ¯çŸ¥è¯†ï¼Œæå‡å½±å“åŠ›ã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹è¿™äº›æ–‡ç« ï¼š</p><br><ul> <li><a href="/2024/10/29/VS-Code-Thankyou/">æˆ‘ä¸º VS Code è´¡çŒ®äº†ä»£ç </a></li><li><a href="2024/08/24/LSP1/">LSP ä¸ VS Code æ’ä»¶å¼€å‘ ç¬¬ä¸€ç« </a></li><li><a href="2023/03/30/æ€ä¹ˆè®©-favicon-åŠ¨èµ·æ¥/">æ€ä¹ˆè®© favicon åŠ¨èµ·æ¥</a></li></ul><hr><div class="post"><h1 class="post-title">ChatGPT çš„æµå¼å¯¹è¯æ˜¯æ€ä¹ˆå®ç°çš„</h1><div class="post-meta">2023-03-20</div><div class="post-content"><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ç½‘é¡µé‡Œ ChatGPT æ˜¯é€å­—è¾“å‡ºæ–‡å­—çš„ï¼Œå¾ˆåƒäººç±»åœ¨ä¸€ä¸ªä¸€ä¸ªæ‰“å­—ï¼š<br><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/sse2.gif" alt="img"></p>
<p>API æ–‡æ¡£é‡Œè¿™ç§æ–¹å¼ç§°ä¸ºâ€œæµå¼â€ <code>stream</code>ï¼Œå®ç°æ–¹æ³•æ˜¯ <code>server-sent events</code>(SSE)ã€‚æœ¬è´¨ä¸Šå®ƒæ˜¯ HTTP è¯·æ±‚ï¼Œå¯ä»¥å®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¸€æ®µä¸€æ®µåœ°æ¨é€æ¶ˆæ¯ã€‚</p>
<p>ä¸ <code>WebSocket</code> ä¸åŒçš„æ˜¯ï¼Œ<code>SEE</code> ä¾ç„¶ç”¨ HTTP åè®®ï¼Œè€Œå®¢æˆ·ç«¯ä¸èƒ½å‘æœåŠ¡ç«¯å‘æ¶ˆæ¯ï¼Œæ•°æ®æµæ˜¯<strong>å•å‘</strong>çš„ï¼Œæ›´åŠ è½»é‡ã€‚</p>
<h2 id="SSE"><a href="#SSE" class="headerlink" title="SSE"></a>SSE</h2><p>è®© ChatGPT åˆ†åˆ«å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ <code>SSE</code> å®ä¾‹ï¼š</p>
<p>æœåŠ¡ç«¯ç”¨ node:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">  res.setHeader(</span><br><span class="line">    <span class="string">&quot;Access-Control-Allow-Headers&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Origin, X-Requested-With, Content-Type, Accept&quot;</span></span><br><span class="line">  );</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/events&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®å“åº”å¤´</span></span><br><span class="line">  res.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">  res.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">  res.setHeader(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> maxCount = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> intervalId = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; maxCount) &#123;</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString();</span><br><span class="line">      res.write(<span class="string">`data: <span class="subst">$&#123;date&#125;</span>\n\n`</span>);</span><br><span class="line">      count++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(intervalId);</span><br><span class="line">      res.end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œåœæ­¢å‘é€æ•°æ®</span></span><br><span class="line">  req.on(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(intervalId);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Listening on port 3000&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = <span class="keyword">new</span> EventSource(<span class="string">&quot;http://localhost:3000/events&quot;</span>);</span><br><span class="line"></span><br><span class="line">source.addEventListener(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event.data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>å¯è§ <code>SSE</code> è¯·æ±‚æœ‰è¿™äº›ç‰¹å¾ï¼š</p>
<ul>
<li>æ•°æ®æ˜¯çº¯æ–‡æœ¬ï¼ˆ<code>text/event-stream</code>ï¼‰ï¼Œå…·ä½“æ˜¯ utf-8 ç¼–ç çš„æ–‡æœ¬ï¼Œæ¯”èµ·äºŒè¿›åˆ¶æ•ˆç‡è¦ä½</li>
<li>ä½¿ç”¨é•¿è¿æ¥ï¼ˆ<code>keep-alive</code>ï¼‰ï¼Œå¤ç”¨ä¸€ä¸ª TCP è¿æ¥</li>
<li>æ•°æ®ä¸è¢«ç¼“å­˜ï¼ˆ<code>no-cache</code>ï¼‰ï¼Œä¿è¯æ‹¿åˆ°æ•°æ®çš„å®æ—¶æ€§</li>
</ul>
<p>devtool ä¸­ä»¥ <code>EventStream</code> çš„å½¢å¼æ˜¾ç¤ºæ•°æ®</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream.png" alt="img"></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ ChatGPT ç½‘ç«™é‡Œå¼€ devtoolï¼ŒSSE è¯·æ±‚æ˜¯çœ‹ä¸åˆ° <code>EventStream</code> çš„ï¼Œä¼¼ä¹æ˜¯<a target="_blank" rel="noopener" href="https://github.com/Azure/fetch-event-source/issues/3">æœ¬åœ°è°ƒè¯•</a>æ‰èƒ½çœ‹åˆ°æ•°æ®ã€‚</p>
<h2 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h2><p>æœåŠ¡ç«¯æ¯æ¬¡å‘é€ <code>SSE</code> <strong>æ¶ˆæ¯</strong>ï¼ˆä¸€æ¬¡æ¶ˆæ¯æŒ‡å®¢æˆ·ç«¯ <code>EventSource</code> é€šè¿‡ <code>EventListener</code> æ”¶åˆ°ä¸€æ¬¡äº‹ä»¶ï¼‰ï¼Œç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ª <code>message</code> ç»„æˆï¼Œæ¯ä¸ª <code>message</code> éƒ½èƒ½ä¼ é€’ <code>Id</code>ã€<code>Type</code>ã€<code>Data</code> è¿™ä¸‰é¡¹æ•°æ®ï¼Œ<code>message</code> çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[field]: value\n</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ field å¯ä»¥æ˜¯ <code>id</code>ã€<code>event</code> ã€ <code>data</code>ï¼Œå¯¹åº” devtool ä¸­çš„ä¸‰ä¸ªè¡¨å¤´ï¼Œè¿˜å¯ä»¥æ˜¯ <code>retry</code>ã€‚å¯è§ä¸€æ¡ <code>message</code> ä»¥ <code>\n</code> ç»“å°¾</p>
<h2 id="data"><a href="#data" class="headerlink" title="data"></a>data</h2><p><code>data</code> ä»£è¡¨æ•°æ®å†…å®¹ï¼Œæ¯æ¡æ•°æ®ä»¥ <code>\n</code> ç»“å°¾ã€‚å‰è¾¹è¯´ä¸€æ¬¡æ¶ˆæ¯å¯èƒ½å¯¹åº”ä¸€ä¸ªæˆ–è€…å¤šä¸ª <code>message</code>ï¼Œæ¯”å¦‚ä¼ é€’ä¸€è¡Œæ•°æ®ï¼Œå°±æ˜¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data: message\n\n</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯<strong>ä¸¤ä¸ª</strong> <code>\n</code>ï¼Œå…¶å®æ˜¯å’Œå‰è¾¹è¯´ <code>message</code> ä¹Ÿä»¥ <code>\n</code> ç»“å°¾ï¼Œæ˜¯ç›¸é€šçš„ï¼Œä¼ é€’å¤šè¡Œæ•°æ®æ—¶å°±èƒ½çœ‹å‡ºåŒºåˆ«äº†ï¼šæ¯”å¦‚ä¼ ä¸€ä¸ª <code>JSON</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data: &#123;\n</span><br><span class="line">data: &quot;a&quot;: 2,\n</span><br><span class="line">data: &quot;b&quot;: true\n</span><br><span class="line">data: &#125;\n\n</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ¬¡æ¶ˆæ¯é‡Œæœ‰å››æ¡ messageï¼Œå…¶ä¸­å‰è¾¹éƒ½æ˜¯<em>ä¸€ä¸ª</em> <code>\n</code>ï¼Œæœ€åæ˜¯<em>ä¸¤ä¸ª</em> <code>\n</code> ç»“å°¾ã€‚å¯ä»¥ç†è§£ä¸ºå¤šå‡ºæ¥çš„ <code>\n</code> ä»£è¡¨è¿™æ¬¡æ¶ˆæ¯ç»“æŸäº†ã€‚å®¢æˆ·ç«¯æ”¶åˆ°çš„ï¼Œæ˜¯ä¸€æ¡å®Œæ•´çš„ <code>JSON</code> å­—ç¬¦ä¸²</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream-data.png" alt="img"></p>
<h2 id="type"><a href="#type" class="headerlink" title="type"></a>type</h2><p><code>type</code> å®šä¹‰äº‹ä»¶ç±»å‹ï¼Œåœ¨å®¢æˆ·ç«¯ <code>EventSource</code> é™¤äº†ç›‘å¬é»˜è®¤çš„ <code>message</code> äº‹ä»¶ï¼Œè¿˜å¯ä»¥ç›‘å¬è‡ªå®šä¹‰ç±»å‹çš„äº‹ä»¶ï¼Œæ˜¯ä¸€ç§åˆ†å‘æ¶ˆæ¯çš„æœºåˆ¶ã€‚</p>
<p>æœåŠ¡å™¨åœ¨å‰è¾¹çš„ä¾‹å­åå†å‘ä¸€æ®µè‡ªå®šä¹‰äº‹ä»¶ <code>someEvent</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">event: someEvent\n           # å’Œå‰ä¸€ä¸ªä¾‹å­ä¸€æ ·ï¼Œä¸€ä¸ª \n ä»£è¡¨æ¶ˆæ¯æ²¡ç»“æŸï¼Œmessage ç»“æŸäº†</span><br><span class="line">data: custom event\n\n       # ä¸¤ä¸ª \n ä»£è¡¨ä¸€æ¬¡æ¶ˆæ¯ç»“æŸ</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ç›‘å¬äº‹ä»¶ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source.addEventListener(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;message:&quot;</span> + event.data);</span><br><span class="line">&#125;);</span><br><span class="line">source.addEventListener(<span class="string">&quot;someEvent&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;someEvent&quot;</span> + event.data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼š<br><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream-type.png" alt="img"></p>
<p>åœ¨å®¢æˆ·ç«¯ï¼Œ<code>EventSource</code> åªèƒ½ç›‘å¬ä¸€ä¸ªç±»å‹çš„æ¶ˆæ¯ï¼Œéœ€è¦è‡ªå·±é€‰æ‹©æ˜¯é»˜è®¤çš„ <code>message</code>ï¼Œè¿˜æ˜¯è‡ªå®šä¹‰çš„äº‹ä»¶åå­—ï¼Œè¿™ä¸ªå’Œ <code>DOM</code> çš„ <code>addEventListener</code> å¾ˆåƒã€‚</p>
<h2 id="id"><a href="#id" class="headerlink" title="id"></a>id</h2><p><code>SSE</code> è‡ªå¸¦äº†æ–­çº¿é‡è¿åŠŸèƒ½ï¼Œè¿™ä¹Ÿæ˜¯æ¯”èµ· <code>WebSocket</code> éœ€è¦è‡ªå»ºæ–­çº¿é‡è¿åŠŸèƒ½çš„ä¼˜åŠ¿ã€‚æ–¹æ³•å°±æ˜¯æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼ ä¸€ä¸ª <code>id</code>ï¼Œå®¢æˆ·ç«¯è®°å½•åœ¨å®ä¾‹çš„ <code>eventSource.lastEventId</code> é‡Œã€‚é‡æ–°è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å¤´ï¼ˆ<code>header</code>ï¼‰ä¼šä¼ ä¸€ä¸ª <code>Last-Event-ID</code>ï¼Œå‘ŠçŸ¥æœåŠ¡å™¨æ”¶åˆ°äº†å“ªäº›æ¶ˆæ¯ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://zh.javascript.info/server-sent-events">ç°ä»£ JavaScript æ•™ç¨‹</a>ä¸­æ¨èæœåŠ¡ç«¯æŠŠ <code>id</code> é™„åŠ åˆ° <code>data</code> åï¼Œç¡®ä¿ <code>data</code> å…¨éƒ¨æ”¶åˆ°åå†æ›´æ–° <code>lastEventId</code>ã€‚æˆ‘ç†è§£åŸå› æ˜¯å…ˆæ”¶åˆ° <code>id</code>ï¼Œå¦‚æœåœ¨æ¥æ”¶ <code>data</code> æ—¶æ–­ç½‘ï¼Œæ²¡æœ‰æ”¶åˆ°å®Œæ•´çš„æ•°æ®ï¼Œä½†å·²ç»æ”¹å˜è¿‡ <code>lastEventId</code>ï¼Œé‡è¿æ—¶è¿™æ®µ <code>data</code> å°±ä¸¢äº†ã€‚</p>
<blockquote>
<p>æˆ‘ç†è§£è¿™æ®µé€»è¾‘å’Œ TCP å‘é€æŠ¥æ–‡æ˜¯å¼‚æ›²åŒå·¥çš„ï¼Œä½†æ˜¯æ›´è½»é‡ã€‚<br><code>id</code> åº”è¯¥æ˜¯æœ‰è§„å¾‹çš„å€¼ï¼Œè¿™æ ·æ¶ˆæ¯æ‰æ˜¯æœ‰åºçš„ï¼ŒæœåŠ¡ç«¯ä¹Ÿèƒ½ç”¨ä¸€ä¸ª <code>lastEventId</code> å°±çŸ¥é“åç»­å‘å“ªäº›æ¶ˆæ¯ã€‚</p>
</blockquote>
<blockquote>
<p>ä¸è¿‡ <code>SSE</code> æ˜¯å•å‘é€šä¿¡ï¼Œä¸ç”¨æ‹…å¿ƒè¢«çŒœåˆ°æ»‘åŠ¨çª—å£èŒƒå›´å†…çš„ ISNï¼Œç”¨ RST æŠ¥æ–‡æ¶æ„æ”»å‡»ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¸‰æ¬¡æ¡æ‰‹äº¤æ¢ ISNã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event: otherEvent \n</span><br><span class="line">data: custom message \n</span><br><span class="line">id: 1\n\n</span><br><span class="line"></span><br><span class="line">data: object: \n</span><br><span class="line">id: 2\n\n</span><br></pre></td></tr></table></figure>

<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream-id.png" alt="img"></p>
<h2 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h2><p><code>retry</code> å¯ä»¥è®©æœåŠ¡ç«¯è®¾ç½®æ¯æ¬¡å®¢æˆ·ç«¯æ–­çº¿åï¼Œæ¯æ¬¡é‡è¿ä¹‹é—´çš„å»¶è¿Ÿå“åº”æ—¶é—´ã€‚</p>
<h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><p>æœåŠ¡ç«¯ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">  res.setHeader(</span><br><span class="line">    <span class="string">&quot;Access-Control-Allow-Headers&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Origin, X-Requested-With, Content-Type, Accept&quot;</span></span><br><span class="line">  );</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/events&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®å“åº”å¤´</span></span><br><span class="line">  res.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">  res.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">  res.setHeader(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> data = [</span><br><span class="line">    <span class="string">&quot;event: otherEvent \n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data: custom message \n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id: 1\n\n&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;data: object: \n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id: 2\n\n&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;data: &#123; \n&quot;</span>,</span><br><span class="line">    <span class="string">`data: &quot;a&quot;: 2,\n`</span>,</span><br><span class="line">    <span class="string">`data: &quot;b&quot;: true\n`</span>,</span><br><span class="line">    <span class="string">&quot;data: &#125; \n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id: 3\n\n&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;event: someEvent\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data: custom event\n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id: 4\n\n&quot;</span>,</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> intervalId = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; data.length) &#123;</span><br><span class="line">      res.write(data[count]);</span><br><span class="line">      <span class="comment">// res.write(`event: bye\ndata: bye-bye\n\n`)</span></span><br><span class="line">      count++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(intervalId);</span><br><span class="line">      res.end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œåœæ­¢å‘é€æ•°æ®</span></span><br><span class="line">  req.on(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(intervalId);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Listening on port 3000&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> source = <span class="keyword">new</span> EventSource(<span class="string">&quot;http://localhost:3000/events&quot;</span>);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">  source.addEventListener(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">&quot;message: &quot;</span> + event.data);</span></span><br><span class="line"><span class="javascript">  &#125;);</span></span><br><span class="line"><span class="javascript">  source.addEventListener(<span class="string">&quot;someEvent&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">&quot;someEvent: &quot;</span> + event.data);</span></span><br><span class="line"><span class="javascript">  &#125;);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ node å¯åŠ¨æœåŠ¡å™¨ï¼Œå°±å¯ä»¥åœ¨æµè§ˆå™¨é‡Œçœ‹åˆ° <code>SSE</code> è¯·æ±‚äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a target="_blank" rel="noopener" href="https://zh.javascript.info/server-sent-events">ç°ä»£ JavaScript æ•™ç¨‹</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events/Using_server-sent_events">MDN-ä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶</a></p>
</div><div class="tags"><a href="/blog/tags/HTTP/"><i class="fa fa-tag"></i>HTTP</a></div><div class="post-nav"><a class="pre" href="/blog/2023/03/30/%E6%80%8E%E4%B9%88%E8%AE%A9-favicon-%E5%8A%A8%E8%B5%B7%E6%9D%A5/">æ€ä¹ˆè®© favicon åŠ¨èµ·æ¥</a><a class="next" href="/blog/2023/03/16/%E5%A6%82%E4%BD%95%E5%8F%82%E4%B8%8E%E7%BC%96%E8%BE%91-mdn-%E4%B8%AD%E6%96%87%E9%A1%B5%E9%9D%A2/">å¦‚ä½•å‚ä¸ç¼–è¾‘ mdn ä¸­æ–‡é¡µé¢</a></div><div class="giscus"></div><script src="https://giscus.app/client.js" data-repo="imbant/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkyNDkzOTc0NDM=" data-category="General" data-category-id="DIC_kwDODt2Aw84Ch79K" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://imbant.github.io/blog"/></form></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><span id="footer-copyright">Copyright Â© </span><a href="/blog/." rel="nofollow">imbAnt's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script>const tag = document.getElementById('footer-copyright');const year = new Date().getFullYear();tag.innerText += year + ' ';</script></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/gifFavIcon.js"></script></div></body></html>