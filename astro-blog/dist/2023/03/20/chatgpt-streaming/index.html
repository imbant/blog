<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><meta name="description" content="了解 ChatGPT 流式对话的实现原理，包括 Server-Sent Events (SSE) 技术详解"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/blog/favicon.svg"><meta name="generator" content="Astro v5.10.2"><title>ChatGPT 的流式对话是怎么实现的 | imbAnt&#39;s blog</title><!-- SEO Meta Tags --><meta property="og:title" content="ChatGPT 的流式对话是怎么实现的 | imbAnt's blog"><meta property="og:description" content="了解 ChatGPT 流式对话的实现原理，包括 Server-Sent Events (SSE) 技术详解"><meta property="og:type" content="website"><meta property="og:url" content="https://imbant.github.io/blog/2023/03/20/chatgpt-streaming/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ChatGPT 的流式对话是怎么实现的 | imbAnt's blog"><meta name="twitter:description" content="了解 ChatGPT 流式对话的实现原理，包括 Server-Sent Events (SSE) 技术详解"><style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;line-height:1.6;color:#333;background-color:#fff}.nav{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;border-bottom:1px solid #eee}.nav-home{font-size:1.25rem;font-weight:700;text-decoration:none;color:#333}.nav-links{display:flex;gap:1rem}.nav-links a{text-decoration:none;color:#666;padding:.5rem}.nav-links a:hover{color:#333}footer{margin-top:4rem;padding:2rem;text-align:center;border-top:1px solid #eee;color:#666}
.container[data-astro-cid-bvzihdzo]{max-width:800px;margin:0 auto;padding:2rem}.post[data-astro-cid-bvzihdzo]{margin-bottom:2rem}.post-header[data-astro-cid-bvzihdzo]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid #eee}.post-title[data-astro-cid-bvzihdzo]{font-size:2rem;margin-bottom:1rem;line-height:1.3}.post-meta[data-astro-cid-bvzihdzo]{display:flex;align-items:center;gap:1rem;color:#666;font-size:.9rem}.post-tags[data-astro-cid-bvzihdzo]{display:flex;gap:.5rem;flex-wrap:wrap}.tag[data-astro-cid-bvzihdzo]{background:#f1f1f1;padding:.25rem .5rem;border-radius:.25rem;font-size:.8rem}.post-content[data-astro-cid-bvzihdzo]{line-height:1.8}.post-content[data-astro-cid-bvzihdzo] h2[data-astro-cid-bvzihdzo],.post-content[data-astro-cid-bvzihdzo] h3[data-astro-cid-bvzihdzo],.post-content[data-astro-cid-bvzihdzo] h4[data-astro-cid-bvzihdzo]{margin:2rem 0 1rem;line-height:1.3}.post-content[data-astro-cid-bvzihdzo] p[data-astro-cid-bvzihdzo]{margin-bottom:1rem}.post-content[data-astro-cid-bvzihdzo] pre[data-astro-cid-bvzihdzo]{background:#f8f9fa;padding:1rem;border-radius:.25rem;overflow-x:auto;margin:1rem 0}.post-content[data-astro-cid-bvzihdzo] code[data-astro-cid-bvzihdzo]{background:#f1f1f1;padding:.1rem .3rem;border-radius:.2rem;font-size:.9rem}.post-content[data-astro-cid-bvzihdzo] pre[data-astro-cid-bvzihdzo] code[data-astro-cid-bvzihdzo]{background:none;padding:0}.post-content[data-astro-cid-bvzihdzo] blockquote[data-astro-cid-bvzihdzo]{border-left:4px solid #ddd;margin:1rem 0;padding-left:1rem;color:#666}.giscus[data-astro-cid-bvzihdzo]{margin-top:3rem;padding-top:2rem;border-top:1px solid #eee}
</style></head> <body> <header> <nav class="nav"> <a href="/blog/" class="nav-home">imbAnt's blog</a> <div class="nav-links"> <a href="/blog/">首页</a> <a href="/blog/archives/">归档</a> <a href="/blog/about/">关于</a> </div> </nav> </header>  <main class="container" data-astro-cid-bvzihdzo> <article class="post" data-astro-cid-bvzihdzo> <header class="post-header" data-astro-cid-bvzihdzo> <h1 class="post-title" data-astro-cid-bvzihdzo>ChatGPT 的流式对话是怎么实现的</h1> <div class="post-meta" data-astro-cid-bvzihdzo> <time data-astro-cid-bvzihdzo>2023-03-20</time> <div class="post-tags" data-astro-cid-bvzihdzo> <span class="tag" data-astro-cid-bvzihdzo>#HTTP</span> </div> </div> </header> <div class="post-content" data-astro-cid-bvzihdzo>  <h2 id="背景">背景</h2>
<p>网页里 ChatGPT 是逐字输出文字的，很像人类在一个一个打字：
<img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/sse2.gif" alt="img"></p>
<p>API 文档里这种方式称为“流式” <code>stream</code>，实现方法是 <code>server-sent events</code>(SSE)。本质上它是 HTTP 请求，可以实现服务端向客户端一段一段地推送消息。</p>
<p>与 <code>WebSocket</code> 不同的是，<code>SEE</code> 依然用 HTTP 协议，而客户端不能向服务端发消息，数据流是<strong>单向</strong>的，更加轻量。</p>
<h2 id="sse">SSE</h2>
<p>让 ChatGPT 分别实现服务端和客户端的 <code>SSE</code> 实例：</p>
<p>服务端用 node:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> express</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> require</span><span style="color:#24292E">(</span><span style="color:#032F62">"express"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> app</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> express</span><span style="color:#24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// 设置允许跨域请求</span></span>
<span class="line"><span style="color:#24292E">app.</span><span style="color:#6F42C1">use</span><span style="color:#24292E">(</span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">req</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#24292E">, </span><span style="color:#E36209">next</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Access-Control-Allow-Origin"</span><span style="color:#24292E">, </span><span style="color:#032F62">"*"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#032F62">    "Access-Control-Allow-Headers"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "Origin, X-Requested-With, Content-Type, Accept"</span></span>
<span class="line"><span style="color:#24292E">  );</span></span>
<span class="line"><span style="color:#6F42C1">  next</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">app.</span><span style="color:#6F42C1">get</span><span style="color:#24292E">(</span><span style="color:#032F62">"/events"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">req</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#6A737D">  // 设置响应头</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Content-Type"</span><span style="color:#24292E">, </span><span style="color:#032F62">"text/event-stream"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Cache-Control"</span><span style="color:#24292E">, </span><span style="color:#032F62">"no-cache"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Connection"</span><span style="color:#24292E">, </span><span style="color:#032F62">"keep-alive"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  let</span><span style="color:#24292E"> count </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  const</span><span style="color:#005CC5"> maxCount</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 5</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  const</span><span style="color:#005CC5"> intervalId</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> setInterval</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (count </span><span style="color:#D73A49">&#x3C;</span><span style="color:#24292E"> maxCount) {</span></span>
<span class="line"><span style="color:#D73A49">      const</span><span style="color:#005CC5"> date</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> Date</span><span style="color:#24292E">().</span><span style="color:#6F42C1">toISOString</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">      res.</span><span style="color:#6F42C1">write</span><span style="color:#24292E">(</span><span style="color:#032F62">`data: ${</span><span style="color:#24292E">date</span><span style="color:#032F62">}</span><span style="color:#005CC5">\n\n</span><span style="color:#032F62">`</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">      count</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6F42C1">      clearInterval</span><span style="color:#24292E">(intervalId);</span></span>
<span class="line"><span style="color:#24292E">      res.</span><span style="color:#6F42C1">end</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  }, </span><span style="color:#005CC5">5000</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // 当客户端断开连接时，停止发送数据</span></span>
<span class="line"><span style="color:#24292E">  req.</span><span style="color:#6F42C1">on</span><span style="color:#24292E">(</span><span style="color:#032F62">"close"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> () {</span></span>
<span class="line"><span style="color:#6F42C1">    clearInterval</span><span style="color:#24292E">(intervalId);</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> server</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> app.</span><span style="color:#6F42C1">listen</span><span style="color:#24292E">(</span><span style="color:#005CC5">3000</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> () {</span></span>
<span class="line"><span style="color:#24292E">  console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">"Listening on port 3000"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>客户端:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> source</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> EventSource</span><span style="color:#24292E">(</span><span style="color:#032F62">"http://localhost:3000/events"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">source.</span><span style="color:#6F42C1">addEventListener</span><span style="color:#24292E">(</span><span style="color:#032F62">"message"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">event</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(event.data);</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>可见 <code>SSE</code> 请求有这些特征：</p>
<ul>
<li>数据是纯文本（<code>text/event-stream</code>），具体是 utf-8 编码的文本，比起二进制效率要低</li>
<li>使用长连接（<code>keep-alive</code>），复用一个 TCP 连接</li>
<li>数据不被缓存（<code>no-cache</code>），保证拿到数据的实时性</li>
</ul>
<p>devtool 中以 <code>EventStream</code> 的形式显示数据</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream.png" alt="img"></p>
<p>值得一提的是，在 ChatGPT 网站里开 devtool，SSE 请求是看不到 <code>EventStream</code> 的，似乎是<a href="https://github.com/Azure/fetch-event-source/issues/3">本地调试</a>才能看到数据。</p>
<h2 id="数据格式">数据格式</h2>
<p>服务端每次发送 <code>SSE</code> <strong>消息</strong>（一次消息指客户端 <code>EventSource</code> 通过 <code>EventListener</code> 收到一次事件），由一个或者多个 <code>message</code> 组成，每个 <code>message</code> 都能传递 <code>Id</code>、<code>Type</code>、<code>Data</code> 这三项数据，<code>message</code> 的格式如下：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#24292E">[field]: value</span><span style="color:#005CC5">\n</span></span></code></pre>
<p>其中 field 可以是 <code>id</code>、<code>event</code> 、 <code>data</code>，对应 devtool 中的三个表头，还可以是 <code>retry</code>。可见一条 <code>message</code> 以 <code>\n</code> 结尾</p>
<h2 id="data">data</h2>
<p><code>data</code> 代表数据内容，每条数据以 <code>\n</code> 结尾。前边说一次消息可能对应一个或者多个 <code>message</code>，比如传递一行数据，就是：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> message</span><span style="color:#005CC5">\n\n</span></span></code></pre>
<p>这里是<strong>两个</strong> <code>\n</code>，其实是和前边说 <code>message</code> 也以 <code>\n</code> 结尾，是相通的，传递多行数据时就能看出区别了：比如传一个 <code>JSON</code></p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> {</span><span style="color:#005CC5">\n</span></span>
<span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> "a":</span><span style="color:#032F62"> 2,</span><span style="color:#005CC5">\n</span></span>
<span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> "b":</span><span style="color:#005CC5"> true</span><span style="color:#005CC5">\n</span></span>
<span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> }</span><span style="color:#005CC5">\n\n</span></span></code></pre>
<p>这一次消息里有四条 message，其中前边都是<em>一个</em> <code>\n</code>，最后是<em>两个</em> <code>\n</code> 结尾。可以理解为多出来的 <code>\n</code> 代表这次消息结束了。客户端收到的，是一条完整的 <code>JSON</code> 字符串</p>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream-data.png" alt="img"></p>
<h2 id="type">type</h2>
<p><code>type</code> 定义事件类型，在客户端 <code>EventSource</code> 除了监听默认的 <code>message</code> 事件，还可以监听自定义类型的事件，是一种分发消息的机制。</p>
<p>服务器在前边的例子后再发一段自定义事件 <code>someEvent</code>：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#6F42C1">event:</span><span style="color:#032F62"> someEvent</span><span style="color:#005CC5">\n</span><span style="color:#6A737D">           # 和前一个例子一样，一个 \n 代表消息没结束，message 结束了</span></span>
<span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> custom</span><span style="color:#032F62"> event</span><span style="color:#005CC5">\n\n</span><span style="color:#6A737D">       # 两个 \n 代表一次消息结束</span></span></code></pre>
<p>客户端监听事件：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#24292E">source.</span><span style="color:#6F42C1">addEventListener</span><span style="color:#24292E">(</span><span style="color:#032F62">"message"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">event</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">"message:"</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> event.data);</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"><span style="color:#24292E">source.</span><span style="color:#6F42C1">addEventListener</span><span style="color:#24292E">(</span><span style="color:#032F62">"someEvent"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">event</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">"someEvent"</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> event.data);</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>结果如下：
<img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream-type.png" alt="img"></p>
<p>在客户端，<code>EventSource</code> 只能监听一个类型的消息，需要自己选择是默认的 <code>message</code>，还是自定义的事件名字，这个和 <code>DOM</code> 的 <code>addEventListener</code> 很像。</p>
<h2 id="id">id</h2>
<p><code>SSE</code> 自带了断线重连功能，这也是比起 <code>WebSocket</code> 需要自建断线重连功能的优势。方法就是每个消息都传一个 <code>id</code>，客户端记录在实例的 <code>eventSource.lastEventId</code> 里。重新连接时，客户端请求头（<code>header</code>）会传一个 <code>Last-Event-ID</code>，告知服务器收到了哪些消息。</p>
<p><a href="https://zh.javascript.info/server-sent-events">现代 JavaScript 教程</a>中推荐服务端把 <code>id</code> 附加到 <code>data</code> 后，确保 <code>data</code> 全部收到后再更新 <code>lastEventId</code>。我理解原因是先收到 <code>id</code>，如果在接收 <code>data</code> 时断网，没有收到完整的数据，但已经改变过 <code>lastEventId</code>，重连时这段 <code>data</code> 就丢了。</p>
<blockquote>
<p>我理解这段逻辑和 TCP 发送报文是异曲同工的，但是更轻量。
<code>id</code> 应该是有规律的值，这样消息才是有序的，服务端也能用一个 <code>lastEventId</code> 就知道后续发哪些消息。</p>
</blockquote>
<blockquote>
<p>不过 <code>SSE</code> 是单向通信，不用担心被猜到滑动窗口范围内的 ISN，用 RST 报文恶意攻击，所以不需要三次握手交换 ISN。</p>
</blockquote>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#6F42C1">event:</span><span style="color:#032F62"> otherEvent</span><span style="color:#005CC5"> \n</span></span>
<span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> custom</span><span style="color:#032F62"> message</span><span style="color:#005CC5"> \n</span></span>
<span class="line"><span style="color:#6F42C1">id:</span><span style="color:#005CC5"> 1</span><span style="color:#005CC5">\n\n</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">data:</span><span style="color:#032F62"> object:</span><span style="color:#005CC5"> \n</span></span>
<span class="line"><span style="color:#6F42C1">id:</span><span style="color:#005CC5"> 2</span><span style="color:#005CC5">\n\n</span></span></code></pre>
<p><img src="https://imbant-blog.oss-cn-shanghai.aliyuncs.com/blog-img/sse-chatgpt/EventStream-id.png" alt="img"></p>
<h2 id="retry">retry</h2>
<p><code>retry</code> 可以让服务端设置每次客户端断线后，每次重连之间的延迟响应时间。</p>
<h2 id="完整代码">完整代码</h2>
<p>服务端：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> express</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> require</span><span style="color:#24292E">(</span><span style="color:#032F62">"express"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> app</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> express</span><span style="color:#24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// 设置允许跨域请求</span></span>
<span class="line"><span style="color:#24292E">app.</span><span style="color:#6F42C1">use</span><span style="color:#24292E">(</span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">req</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#24292E">, </span><span style="color:#E36209">next</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Access-Control-Allow-Origin"</span><span style="color:#24292E">, </span><span style="color:#032F62">"*"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#032F62">    "Access-Control-Allow-Headers"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "Origin, X-Requested-With, Content-Type, Accept"</span></span>
<span class="line"><span style="color:#24292E">  );</span></span>
<span class="line"><span style="color:#6F42C1">  next</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">app.</span><span style="color:#6F42C1">get</span><span style="color:#24292E">(</span><span style="color:#032F62">"/events"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">req</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#6A737D">  // 设置响应头</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Content-Type"</span><span style="color:#24292E">, </span><span style="color:#032F62">"text/event-stream"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Cache-Control"</span><span style="color:#24292E">, </span><span style="color:#032F62">"no-cache"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">  res.</span><span style="color:#6F42C1">setHeader</span><span style="color:#24292E">(</span><span style="color:#032F62">"Connection"</span><span style="color:#24292E">, </span><span style="color:#032F62">"keep-alive"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  let</span><span style="color:#24292E"> count </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  const</span><span style="color:#005CC5"> data</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> [</span></span>
<span class="line"><span style="color:#032F62">    "event: otherEvent </span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "data: custom message </span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "id: 1</span><span style="color:#005CC5">\n\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62">    "data: object: </span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "id: 2</span><span style="color:#005CC5">\n\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62">    "data: { </span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    `data: "a": 2,</span><span style="color:#005CC5">\n</span><span style="color:#032F62">`</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    `data: "b": true</span><span style="color:#005CC5">\n</span><span style="color:#032F62">`</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "data: } </span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "id: 3</span><span style="color:#005CC5">\n\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62">    "event: someEvent</span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "data: custom event</span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#032F62">    "id: 4</span><span style="color:#005CC5">\n\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  const</span><span style="color:#005CC5"> intervalId</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> setInterval</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (count </span><span style="color:#D73A49">&#x3C;</span><span style="color:#24292E"> data.</span><span style="color:#005CC5">length</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">      res.</span><span style="color:#6F42C1">write</span><span style="color:#24292E">(data[count]);</span></span>
<span class="line"><span style="color:#6A737D">      // res.write(`event: bye\ndata: bye-bye\n\n`)</span></span>
<span class="line"><span style="color:#24292E">      count</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6F42C1">      clearInterval</span><span style="color:#24292E">(intervalId);</span></span>
<span class="line"><span style="color:#24292E">      res.</span><span style="color:#6F42C1">end</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  }, </span><span style="color:#005CC5">300</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // 当客户端断开连接时，停止发送数据</span></span>
<span class="line"><span style="color:#24292E">  req.</span><span style="color:#6F42C1">on</span><span style="color:#24292E">(</span><span style="color:#032F62">"close"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> () {</span></span>
<span class="line"><span style="color:#6F42C1">    clearInterval</span><span style="color:#24292E">(intervalId);</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> server</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> app.</span><span style="color:#6F42C1">listen</span><span style="color:#24292E">(</span><span style="color:#005CC5">3000</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> () {</span></span>
<span class="line"><span style="color:#24292E">  console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">"Listening on port 3000"</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>客户端：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#24292E">&#x3C;</span><span style="color:#22863A">script</span><span style="color:#24292E">></span></span>
<span class="line"><span style="color:#D73A49">  const</span><span style="color:#005CC5"> source</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> EventSource</span><span style="color:#24292E">(</span><span style="color:#032F62">"http://localhost:3000/events"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">  source.</span><span style="color:#6F42C1">addEventListener</span><span style="color:#24292E">(</span><span style="color:#032F62">"message"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">event</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">"message: "</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> event.data);</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">  source.</span><span style="color:#6F42C1">addEventListener</span><span style="color:#24292E">(</span><span style="color:#032F62">"someEvent"</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">event</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">"someEvent: "</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> event.data);</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">&#x3C;/</span><span style="color:#22863A">script</span><span style="color:#24292E">></span></span></code></pre>
<p>使用 node 启动服务器，就可以在浏览器里看到 <code>SSE</code> 请求了。</p>
<h2 id="参考资料">参考资料</h2>
<p><a href="https://zh.javascript.info/server-sent-events">现代 JavaScript 教程</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events/Using_server-sent_events">MDN-使用服务器发送事件</a></p>  </div> <!-- Giscus Comments --> <div class="giscus" id="giscus-container" data-astro-cid-bvzihdzo> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.setAttribute("data-repo","imbant/blog");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNDkzOTc0NDM=");t.setAttribute("data-category","General");t.setAttribute("data-category-id","DIC_kwDODt2Aw84Ch79K");t.setAttribute("data-mapping","pathname");t.setAttribute("data-strict","0");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-input-position","bottom");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","zh-CN");t.setAttribute("crossorigin","anonymous");t.async=!0;document.getElementById("giscus-container").appendChild(t);</script> </div> </article> </main>  <footer> <p>&copy; 2025 imbant. All rights reserved.</p> </footer> </body></html> 